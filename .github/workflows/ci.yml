name: ğŸ” Academic Website CI/CD
# Dr. Uthayasanker Thayasivam's Research Portfolio - Continuous Integration

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # JSON Validation Job
  validate-json:
    name: ğŸ“‹ JSON Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ” Validate JSON files
        run: |
          echo "ğŸ“‹ Validating JSON structure..."
          find ./data -name "*.json" -type f | while read file; do
            echo "Checking $file..."
            python3 -m json.tool "$file" > /dev/null && echo "âœ… $file is valid" || { echo "âŒ $file is invalid"; exit 1; }
          done

      - name: ğŸ—ï¸ Validate JSON Schema (Content)
        run: |
          echo "ğŸ“„ Validating content.json structure..."
          python3 -c "
          import json
          import sys

          with open('data/content.json') as f:
              data = json.load(f)

          required_sections = ['home', 'biography', 'research', 'teaching', 'awards']
          for section in required_sections:
              if section not in data:
                  print(f'âŒ Missing required section: {section}')
                  sys.exit(1)
              else:
                  print(f'âœ… Section {section} found')

          print('âœ… Content structure validation passed!')
          "

      - name: ğŸ“ Validate Teaching Data
        run: |
          echo "ğŸ‘¨â€ğŸ« Validating teaching.json structure..."
          python3 -c "
          import json
          import sys

          with open('data/teaching.json') as f:
              data = json.load(f)

          if 'teaching' not in data:
              print('âŒ Missing teaching root object')
              sys.exit(1)

          teaching = data['teaching']
          required_fields = ['summary', 'featured', 'courses', 'categories']
          for field in required_fields:
              if field not in teaching:
                  print(f'âŒ Missing required field: {field}')
                  sys.exit(1)
              else:
                  print(f'âœ… Field {field} found')

          print('âœ… Teaching structure validation passed!')
          "

      - name: ğŸ“Š Validate Projects Data
        run: |
          echo "ğŸ”¬ Validating projects data..."
          python3 -c "
          import json
          import sys
          import os

          # Validate projects index
          with open('data/projects/projects.json') as f:
              projects_index = json.load(f)

          if 'projects' not in projects_index:
              print('âŒ Missing projects array in index')
              sys.exit(1)

          # Validate each project file exists and has required fields
          for project_ref in projects_index['projects']:
              project_id = project_ref['id']
              project_file = f'data/projects/{project_id}/project.json'

              if not os.path.exists(project_file):
                  print(f'âŒ Missing project file: {project_file}')
                  sys.exit(1)

              with open(project_file) as f:
                  project_data = json.load(f)

              required_fields = ['id', 'title', 'shortDescription', 'tags', 'status']
              for field in required_fields:
                  if field not in project_data:
                      print(f'âŒ Missing field {field} in project {project_id}')
                      sys.exit(1)

              print(f'âœ… Project {project_id} validation passed')

          print('âœ… Projects structure validation passed!')
          "

  # Code Quality Job
  code-quality:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    needs: validate-json
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing linting and formatting tools..."
          npm install -g prettier@latest htmlhint@latest eslint@latest
          echo "âœ… Dependencies installed!"

      - name: ğŸ¨ Check code formatting
        run: |
          echo "ğŸ¨ Checking code formatting with Prettier..."

          # Check HTML files
          echo "ğŸ“„ Checking HTML formatting..."
          find . -name "*.html" -not -path "./node_modules/*" | xargs prettier --check --tab-width 4 --print-width 120

          # Check JavaScript files
          echo "ğŸ“œ Checking JavaScript formatting..."
          find . -name "*.js" -not -path "./node_modules/*" | xargs prettier --check --tab-width 4 --print-width 120 --single-quote

          # Check JSON files
          echo "ğŸ“‹ Checking JSON formatting..."
          find . -name "*.json" -not -path "./node_modules/*" | xargs prettier --check --tab-width 2

          echo "âœ… Code formatting check passed!"

      - name: ğŸ” Lint HTML files
        run: |
          echo "ğŸ“„ Linting HTML files..."
          find . -name "*.html" -not -path "./node_modules/*" -exec htmlhint {} \;
          echo "âœ… HTML linting completed!"

      - name: ğŸ“œ Lint JavaScript files
        run: |
          echo "ğŸ“œ Linting JavaScript files..."
          # Create basic ESLint config
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 12,
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off",
              "semi": ["error", "always"]
            }
          }
          EOF

          find . -name "*.js" -not -path "./node_modules/*" -exec eslint {} \; || echo "âš ï¸ ESLint warnings found"
          echo "âœ… JavaScript linting completed!"

      - name: ğŸ”— Check for broken links
        run: |
          echo "ğŸ”— Checking for potential broken internal links..."
          python3 -c "
          import os
          import re

          def check_file_exists(href, current_file_dir):
              # Skip external links, mailto, and anchors
              if href.startswith(('http', 'mailto:', '#')):
                  return True

              # Convert relative path to absolute
              if href.startswith('./'):
                  href = href[2:]

              # Check if file exists
              full_path = os.path.join(current_file_dir, href)
              return os.path.exists(full_path)

          broken_links = []
          html_files = []
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.html'):
                      html_files.append(os.path.join(root, file))

          for html_file in html_files:
              with open(html_file, 'r', encoding='utf-8') as f:
                  content = f.read()

              # Find all href attributes
              hrefs = re.findall(r'href=\"([^\"]+)\"', content)
              current_dir = os.path.dirname(html_file)

              for href in hrefs:
                  if not check_file_exists(href, current_dir):
                      broken_links.append(f'{html_file}: {href}')

          if broken_links:
              print('âš ï¸ Potential broken links found:')
              for link in broken_links:
                  print(f'  {link}')
          else:
              print('âœ… No broken internal links detected!')
          "

  # Security and Performance
  security-performance:
    name: ğŸ”’ Security & Performance
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Security scan for secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          # Check for common secret patterns
          if grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.json" --include="*.html" . | grep -v "placeholder\|example\|test"; then
            echo "âš ï¸ Potential secrets found in code!"
            exit 1
          else
            echo "âœ… No secrets detected in code!"
          fi

      - name: ğŸ“Š File size check
        run: |
          echo "ğŸ“Š Checking file sizes..."
          find . -name "*.html" -o -name "*.js" -o -name "*.css" | while read file; do
            size=$(wc -c < "$file")
            if [ $size -gt 500000 ]; then  # 500KB limit
              echo "âš ï¸ Large file detected: $file ($size bytes)"
            fi
          done
          echo "âœ… File size check completed!"

      - name: ğŸ–¼ï¸ Image optimization check
        run: |
          echo "ğŸ–¼ï¸ Checking image files..."
          if [ -d "images" ]; then
            find images -name "*.jpg" -o -name "*.png" -o -name "*.gif" | while read img; do
              size=$(wc -c < "$img")
              if [ $size -gt 2000000 ]; then  # 2MB limit
                echo "âš ï¸ Large image: $img ($size bytes) - consider optimization"
              fi
            done
          fi
          echo "âœ… Image check completed!"

  # Deployment Preview (for main branch)
  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: [validate-json, code-quality, security-performance]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python for server
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ§ª Test local server
        run: |
          echo "ğŸ§ª Testing local server startup..."
          timeout 10s python3 -m http.server 8000 &
          sleep 5
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "âœ… Server started successfully!"
          else
            echo "âŒ Server failed to start!"
            exit 1
          fi

      - name: ğŸ“‹ Generate deployment report
        run: |
          echo "ğŸ“‹ Deployment Report" > deployment-report.md
          echo "===================" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "ğŸ›ï¸ **Dr. Uthayasanker Thayasivam's Academic Website**" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "ğŸ“Š **Statistics:**" >> deployment-report.md
          echo "- HTML files: $(find . -name '*.html' | wc -l)" >> deployment-report.md
          echo "- JavaScript files: $(find . -name '*.js' | wc -l)" >> deployment-report.md
          echo "- JSON files: $(find . -name '*.json' | wc -l)" >> deployment-report.md
          echo "- Images: $(find images -name '*' 2>/dev/null | wc -l || echo 0)" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "âœ… **Status:** All checks passed - Ready for deployment!" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "ğŸŒ **Pages:**" >> deployment-report.md
          find . -maxdepth 1 -name "*.html" -exec basename {} \; | sort | sed 's/^/- /' >> deployment-report.md

          echo "ğŸ“‹ Deployment report generated:"
          cat deployment-report.md

      - name: ğŸ“¤ Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: academic-website
          path: |
            .
            !.git
            !node_modules
            !.github
          retention-days: 30

  # Notification Job
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [validate-json, code-quality, security-performance, deploy-preview]
    if: always()
    steps:
      - name: ğŸ“Š Report Status
        run: |
          echo "ğŸ“Š CI/CD Pipeline Results:"
          echo "========================="
          echo "ğŸ“‹ JSON Validation: ${{ needs.validate-json.result }}"
          echo "ğŸ¨ Code Quality: ${{ needs.code-quality.result }}"
          echo "ğŸ”’ Security & Performance: ${{ needs.security-performance.result }}"
          echo "ğŸš€ Deploy Preview: ${{ needs.deploy-preview.result }}"

          if [[ "${{ needs.validate-json.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" && "${{ needs.security-performance.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ All checks passed! Academic website is ready for deployment."
            echo "ğŸ›ï¸ Dr. Uthayasanker Thayasivam's Research Portfolio"
            echo "ğŸŒ University of Moratuwa - Computer Science & Engineering"
          else
            echo ""
            echo "âŒ Some checks failed. Please review the logs above."
          fi