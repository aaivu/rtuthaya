name: ğŸ” Academic Website CI/CD
# Dr. Uthayasanker Thayasivam's Research Portfolio - Continuous Integration

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # JSON Validation Job
  validate-json:
    name: ğŸ“‹ JSON Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ” Validate JSON files
        run: |
          echo "ğŸ“‹ Validating JSON structure..."
          find ./data -name "*.json" -type f | while read file; do
            echo "Checking $file..."
            python3 -m json.tool "$file" > /dev/null && echo "âœ… $file is valid" || { echo "âŒ $file is invalid"; exit 1; }
          done

      - name: ğŸ—ï¸ Validate JSON Schema (Content)
        run: |
          echo "ğŸ“„ Validating content.json structure..."
          python3 -c "
          import json
          import sys

          with open('data/content.json') as f:
              data = json.load(f)

          required_sections = ['home', 'biography', 'research', 'teaching', 'awards']
          for section in required_sections:
              if section not in data:
                  print(f'âŒ Missing required section: {section}')
                  sys.exit(1)
              else:
                  print(f'âœ… Section {section} found')

          print('âœ… Content structure validation passed!')
          "

      - name: ğŸ“ Validate Teaching Data
        run: |
          echo "ğŸ‘¨â€ğŸ« Validating teaching.json structure..."
          python3 -c "
          import json
          import sys

          with open('data/teaching.json') as f:
              data = json.load(f)

          if 'teaching' not in data:
              print('âŒ Missing teaching root object')
              sys.exit(1)

          teaching = data['teaching']
          required_fields = ['summary', 'featured', 'courses', 'categories']
          for field in required_fields:
              if field not in teaching:
                  print(f'âŒ Missing required field: {field}')
                  sys.exit(1)
              else:
                  print(f'âœ… Field {field} found')

          print('âœ… Teaching structure validation passed!')
          "

      - name: ğŸ“Š Validate Projects Data
        run: |
          echo "ğŸ”¬ Validating projects data..."
          python3 -c "
          import json
          import sys
          import os

          # Validate projects index
          with open('data/projects/projects.json') as f:
              projects_index = json.load(f)

          if 'projects' not in projects_index:
              print('âŒ Missing projects array in index')
              sys.exit(1)

          # Validate each project file exists and has required fields
          for project_ref in projects_index['projects']:
              project_id = project_ref['id']
              project_file = f'data/projects/{project_id}/project.json'

              if not os.path.exists(project_file):
                  print(f'âŒ Missing project file: {project_file}')
                  sys.exit(1)

              with open(project_file) as f:
                  project_data = json.load(f)

              required_fields = ['id', 'title', 'shortDescription', 'tags', 'status']
              for field in required_fields:
                  if field not in project_data:
                      print(f'âŒ Missing field {field} in project {project_id}')
                      sys.exit(1)

              print(f'âœ… Project {project_id} validation passed')

          print('âœ… Projects structure validation passed!')
          "

  # Code Quality Job
  code-quality:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    needs: validate-json
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing linting and formatting tools..."
          npm install -g prettier@latest htmlhint@latest eslint@latest
          echo "âœ… Dependencies installed!"

      - name: ğŸ¨ Check code formatting
        run: |
          echo "ğŸ¨ Checking code formatting with Prettier..."

          # Check HTML files
          echo "ğŸ“„ Checking HTML formatting..."
          find . -name "*.html" -not -path "./node_modules/*" | xargs prettier --check --tab-width 4 --print-width 120

          # Check JavaScript files
          echo "ğŸ“œ Checking JavaScript formatting..."
          find . -name "*.js" -not -path "./node_modules/*" | xargs prettier --check --tab-width 4 --print-width 120 --single-quote

          # Check JSON files
          echo "ğŸ“‹ Checking JSON formatting..."
          find . -name "*.json" -not -path "./node_modules/*" | xargs prettier --check --tab-width 2

          echo "âœ… Code formatting check passed!"

      - name: ğŸ” Lint HTML files
        run: |
          echo "ğŸ“„ Linting HTML files..."
          find . -name "*.html" -not -path "./node_modules/*" -exec htmlhint {} \;
          echo "âœ… HTML linting completed!"

      - name: ğŸ“œ Lint JavaScript files
        run: |
          echo "ğŸ“œ Linting JavaScript files..."
          # Create basic ESLint config
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 12,
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off",
              "semi": ["error", "always"]
            }
          }
          EOF

          find . -name "*.js" -not -path "./node_modules/*" -exec eslint {} \; || echo "âš ï¸ ESLint warnings found"
          echo "âœ… JavaScript linting completed!"

      - name: ğŸ”— Check for broken links
        run: |
          echo "ğŸ”— Checking for potential broken internal links..."
          python3 -c "
          import os
          import re

          def check_file_exists(href, current_file_dir):
              # Skip external links, mailto, and anchors
              if href.startswith(('http', 'mailto:', '#')):
                  return True

              # Convert relative path to absolute
              if href.startswith('./'):
                  href = href[2:]

              # Check if file exists
              full_path = os.path.join(current_file_dir, href)
              return os.path.exists(full_path)

          broken_links = []
          html_files = []
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.html'):
                      html_files.append(os.path.join(root, file))

          for html_file in html_files:
              with open(html_file, 'r', encoding='utf-8') as f:
                  content = f.read()

              # Find all href attributes
              hrefs = re.findall(r'href=\"([^\"]+)\"', content)
              current_dir = os.path.dirname(html_file)

              for href in hrefs:
                  if not check_file_exists(href, current_dir):
                      broken_links.append(f'{html_file}: {href}')

          if broken_links:
              print('âš ï¸ Potential broken links found:')
              for link in broken_links:
                  print(f'  {link}')
          else:
              print('âœ… No broken internal links detected!')
          "

  # Notification Job
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [validate-json, code-quality]
    if: always()
    steps:
      - name: ğŸ“Š Report Status
        run: |
          echo "ğŸ“Š CI/CD Pipeline Results:"
          echo "========================="
          echo "ğŸ“‹ JSON Validation: ${{ needs.validate-json.result }}"
          echo "ğŸ¨ Code Quality: ${{ needs.code-quality.result }}"

          if [[ "${{ needs.validate-json.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ All checks passed! Academic website is ready for deployment."
            echo "ğŸ›ï¸ Dr. Uthayasanker Thayasivam's Research Portfolio"
            echo "ğŸŒ University of Moratuwa - Computer Science & Engineering"
          else
            echo ""
            echo "âŒ Some checks failed. Please review the logs above."
          fi